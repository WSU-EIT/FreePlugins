@* FreeGLBA.App.DataSubjectsPage.razor - List page for DataSubject *@
@* Generated by Entity Builder Wizard *@
@page "/DataSubjects"
@page "/{TenantCode}/DataSubjects"
@implements IDisposable
@inject BlazorDataModel Model
@inject HttpClient Http

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    <div class="container-fluid">
        <div class="@Model.StickyMenuClass">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title mb-0">
                    <i class="fa-solid fa-cubes me-2"></i>DataSubjects
                </h1>
                <button class="btn btn-primary" @onclick="CreateNew">
                    <i class="fa-solid fa-plus me-1"></i>New DataSubject
                </button>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search..."
                                   @bind="_filter.Search" @bind:event="oninput" @bind:after="LoadData" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" @bind="_filter.PageSize" @bind:after="LoadData">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @if (_loading) {
            <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
        } else if (_result.Records.Count == 0) {
            <div class="text-center py-5 text-muted">
                <i class="fa-solid fa-inbox fa-4x mb-3 opacity-50"></i>
                <h4>No datasubjects found</h4>
            </div>
        } else {
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ExternalId</th>
                                <th>SubjectType</th>
                                <th>FirstAccessedAt</th>
                                <th>LastAccessedAt</th>
                                <th>TotalAccessCount</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _result.Records) {
                                <tr>
                                    <td>@item.ExternalId</td>
                                    <td>@item.SubjectType</td>
                                    <td>@item.FirstAccessedAt.ToString("MMM dd, yyyy")</td>
                                    <td>@item.LastAccessedAt.ToString("MMM dd, yyyy")</td>
                                    <td>@item.TotalAccessCount</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="@(() => Edit(item))"><i class="fa-solid fa-pen"></i></button>
                                            <button class="btn btn-outline-danger" @onclick="@(() => ConfirmDelete(item))"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    @if (_showEdit) {
        <FreeGLBA_App_EditDataSubject Item="_editItem" OnSave="SaveItem" OnCancel="CloseEdit" />
    }

    @* Delete Confirmation Modal *@
    @if (_showDeleteConfirm) {
        <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this datasubject?</p>
                        <p class="text-muted small">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">@Helpers.ConfirmButtonTextCancel</button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteConfirmed">@Helpers.ConfirmButtonTextDelete</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private string _pageName = "datasubjects";
    private bool _loading = true;
    private DataObjects.DataSubjectFilter _filter = new();
    private DataObjects.DataSubjectFilterResult _result = new();
    private bool _showEdit = false;
    private DataObjects.DataSubject _editItem = new();
    private bool _showDeleteConfirm = false;
    private DataObjects.DataSubject? _deleteItem = null;

    public void Dispose() { Model.OnChange -= StateHasChanged; }

    protected override void OnInitialized() {
        Model.View = _pageName;
        Model.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) await LoadData();
    }

    private async Task LoadData() {
        _loading = true;
        StateHasChanged();
        _result = await Helpers.GetOrPost<DataObjects.DataSubjectFilterResult>(
            DataObjects.Endpoints.FreeGLBA.GetDataSubjects, _filter) ?? new();
        _loading = false;
        StateHasChanged();
    }

    private void CreateNew() { _editItem = new DataObjects.DataSubject(); _showEdit = true; }
    private void Edit(DataObjects.DataSubject item) { _editItem = item; _showEdit = true; }
    private void CloseEdit() { _showEdit = false; }

    private async Task SaveItem(DataObjects.DataSubject item) {
        await Helpers.GetOrPost<DataObjects.DataSubject>(DataObjects.Endpoints.FreeGLBA.SaveDataSubject, item);
        _showEdit = false;
        await LoadData();
    }

    private void ConfirmDelete(DataObjects.DataSubject item) {
        _deleteItem = item;
        _showDeleteConfirm = true;
    }

    private void CancelDelete() {
        _deleteItem = null;
        _showDeleteConfirm = false;
    }

    private async Task DeleteConfirmed() {
        if (_deleteItem != null) {
            await Helpers.GetOrPost<bool>(DataObjects.Endpoints.FreeGLBA.DeleteDataSubject, _deleteItem.DataSubjectId);
            _deleteItem = null;
            _showDeleteConfirm = false;
            await LoadData();
        }
    }
}
