@* FreeGLBA.App.GlbaDashboard.razor - Dashboard page *@
@* Generated by Entity Builder Wizard *@
@page "/GlbaDashboard"
@page "/{TenantCode}/GlbaDashboard"
@implements IDisposable
@inject BlazorDataModel Model
@inject HttpClient Http

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    @if (_loading) {
        <div class="container-fluid">
            <h1 class="page-title">
                <i class="fa-solid fa-shield-halved me-2"></i>GLBA Compliance Dashboard
            </h1>
            <div class="text-center py-5"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
        </div>
    } else {
        <div class="container-fluid">
            <div class="@Model.StickyMenuClass">
                <h1 class="page-title">
                    <i class="fa-solid fa-shield-halved me-2"></i>GLBA Compliance Dashboard
                </h1>
            </div>

            @* Stats Cards *@
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h2 class="mb-0">@_stats.Today.ToString("N0")</h2>
                            <p class="text-muted mb-0">Today</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h2 class="mb-0">@_stats.ThisWeek.ToString("N0")</h2>
                            <p class="text-muted mb-0">This Week</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">
                            <h2 class="mb-0">@_stats.ThisMonth.ToString("N0")</h2>
                            <p class="text-muted mb-0">This Month</p>
                        </div>
                    </div>
                </div>
            </div>

            @* Recent Events *@
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-clock-rotate-left me-2"></i>Recent Events
                    </h5>
                    <a href="@Helpers.BuildUrl("AccessEvents")" class="btn btn-sm btn-outline-primary">
                        View All <i class="fa-solid fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Accessed At</th>
                                    <th>User Id</th>
                                    <th>Subject Id</th>
                                    <th>Data Category</th>
                                    <th>Access Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in _recentEvents) {
                                    <tr>
                                        <td>@evt.AccessedAt.ToString("g")</td>
                                        <td>@evt.UserId</td>
                                        <td>@evt.SubjectId</td>
                                        <td>@evt.DataCategory</td>
                                        <td>@evt.AccessType</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            @* Source Systems Status *@
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-server me-2"></i>Source Systems
                    </h5>
                    <a href="@Helpers.BuildUrl("SourceSystems")" class="btn btn-sm btn-outline-primary">
                        Manage <i class="fa-solid fa-gear ms-1"></i>
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>System</th>
                                    <th>Status</th>
                                    <th>Last Event</th>
                                    <th>Total Events</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var src in _sources) {
                                    <tr>
                                        <td>@(src.DisplayName ?? src.Name)</td>
                                        <td>
                                            @if (src.IsActive) {
                                                <span class="badge bg-success"><i class="fa-solid fa-circle me-1"></i>Active</span>
                                            } else {
                                                <span class="badge bg-secondary"><i class="fa-solid fa-circle me-1"></i>Inactive</span>
                                            }
                                        </td>
                                        <td>@GetTimeAgo(src.LastEventReceivedAt)</td>
                                        <td>@src.EventCount.ToString("N0")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter] public string? TenantCode { get; set; }

    private string _pageName = "glbadashboard";
    private bool _loading = true;
    private bool _loadedData = false;

    private DataObjects.GlbaStats _stats = new();
    private List<DataObjects.AccessEvent> _recentEvents = new();
    private List<DataObjects.SourceSystem> _sources = new();

    public void Dispose()
    {
        Model.OnChange -= OnDataModelUpdated;
    }

    protected override void OnInitialized()
    {
        Model.View = _pageName;
        Model.OnChange += OnDataModelUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Model.TenantCodeFromUrl = TenantCode;
        }

        if (Model.Loaded && Model.LoggedIn && !_loadedData)
        {
            _loadedData = true;
            await LoadDataAsync();
        }
    }

    private void OnDataModelUpdated()
    {
        if (Model.View == _pageName)
        {
            StateHasChanged();
        }
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Load all data in parallel
            var statsTask = Helpers.GetOrPost<DataObjects.GlbaStats>("api/glba/stats/summary");
            var eventsTask = Helpers.GetOrPost<List<DataObjects.AccessEvent>>("api/glba/events/recent?limit=20");
            var sourcesTask = Helpers.GetOrPost<List<DataObjects.SourceSystem>>("api/glba/sources/status");

            await Task.WhenAll(statsTask, eventsTask, sourcesTask);

            _stats = await statsTask ?? new();
            _recentEvents = await eventsTask ?? new();
            _sources = await sourcesTask ?? new();
        }
        catch (Exception ex)
        {
            Model.ErrorMessage($"Error loading dashboard: {ex.Message}");
        }

        _loading = false;
        StateHasChanged();
    }

    private string GetTimeAgo(DateTime? dt)
    {
        if (!dt.HasValue) return "Never";
        var diff = DateTime.UtcNow - dt.Value;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} min ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hours ago";
        return $"{(int)diff.TotalDays} days ago";
    }
}
