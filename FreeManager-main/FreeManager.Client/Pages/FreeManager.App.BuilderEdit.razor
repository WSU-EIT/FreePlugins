@page "/AppBuilder/Edit/{ProjectId:guid}"
@page "/{TenantCode}/AppBuilder/Edit/{ProjectId:guid}"
@using FreeManager.Client.Shared.AppComponents
@inject BlazorDataModel Model
@implements IDisposable

@if (Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    <FreeManager_App_ProjectEditor ProjectId="ProjectId" />
}

@code {
    [Parameter] public string? TenantCode { get; set; }
    [Parameter] public Guid ProjectId { get; set; }

    protected bool _loadedData = false;
    protected string _pageName = "appbuilder-edit";

    public void Dispose()
    {
        Model.OnChange -= OnDataModelUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            Model.TenantCodeFromUrl = TenantCode;
        }

        if (Model.Loaded) {
            if (Model.LoggedIn) {
                if (!_loadedData) {
                    _loadedData = true;
                    await Helpers.ValidateUrl(TenantCode, true);
                }
            } else {
                Helpers.NavigateToLogin();
            }
        }
    }

    protected void OnDataModelUpdated()
    {
        if (Model.View == _pageName) {
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        Model.View = _pageName;
        Model.OnChange += StateHasChanged;
    }
}
