@* EntityWizardStepper.App.razor - Numbered step circles with visual progress *@
@* Based on FreeCICD WizardStepper pattern *@

<div class="d-flex justify-content-between align-items-start bg-light rounded p-2 mb-2 shadow-sm overflow-auto">
    @for (int i = 0; i < Steps.Count; i++) {
        var stepIndex = i;
        var step = Steps[i];
        var isCompleted = stepIndex < CurrentStep;
        var isCurrent = stepIndex == CurrentStep;
        var isClickable = isCompleted && OnStepClick.HasDelegate;

        <div class="d-flex flex-column align-items-center flex-fill position-relative" style="min-width: 60px;">
            @* Step Circle *@
            <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold border border-2 
                        @(isCompleted ? "bg-success border-success text-white" : 
                          isCurrent ? "bg-primary border-primary text-white shadow" : 
                          "bg-white border-secondary text-muted")"
                 style="width: 32px; height: 32px; font-size: 0.8rem; z-index: 2; @(isClickable ? "cursor: pointer;" : "")"
                 @onclick="@(() => HandleStepClick(stepIndex))"
                 title="@(isClickable ? $"Go back to {step.Name}" : step.Name)">
                @if (isCompleted) {
                    <i class="fa-solid fa-check fa-sm"></i>
                } else if (isCurrent) {
                    <i class="fa-solid fa-circle fa-xs"></i>
                } else {
                    <span>@(stepIndex + 1)</span>
                }
            </div>

            @* Connector Line *@
            @if (stepIndex < Steps.Count - 1) {
                <div class="position-absolute @(isCompleted ? "bg-success" : "bg-secondary")" 
                     style="height: 3px; top: 14px; left: 50%; width: 100%; z-index: 1; opacity: 0.4;"></div>
            }

            @* Step Label *@
            <div class="text-center mt-1" style="max-width: 80px;">
                <div class="small fw-semibold @(isCompleted ? "text-success" : isCurrent ? "text-primary" : "text-muted") text-truncate" style="font-size: 0.75rem;">
                    @step.ShortName
                </div>
                @if (!string.IsNullOrWhiteSpace(step.SelectedValue) && (isCompleted || isCurrent)) {
                    <div class="text-muted text-truncate" style="font-size: 0.65rem;" title="@step.SelectedValue">
                        @TruncateText(step.SelectedValue, 10)
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public List<DataObjects.WizardStepInfo> Steps { get; set; } = new();
    [Parameter] public int CurrentStep { get; set; }
    [Parameter] public EventCallback<int> OnStepClick { get; set; }

    private async Task HandleStepClick(int stepIndex) {
        // Only allow clicking on completed steps
        if (stepIndex < CurrentStep && OnStepClick.HasDelegate) {
            await OnStepClick.InvokeAsync(stepIndex);
        }
    }

    private string TruncateText(string text, int maxLength) {
        if (string.IsNullOrEmpty(text)) return "";
        if (text.Length <= maxLength) return text;
        return text.Substring(0, maxLength - 2) + "..";
    }
}
