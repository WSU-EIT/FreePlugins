@* EntityWizardImportModal.App.razor - Import entity definition from various sources *@

@if (IsOpen) {
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-file-import me-2"></i>
                        Import Entity Definition
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    @if (!_showResults) {
                        @* Source Type Selection *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Import Source</label>
                            <div class="btn-group w-100" role="group">
                                @foreach (var source in _sourceTypes) {
                                    <input type="radio" class="btn-check" name="sourceType"
                                           id="source-@source.Type" autocomplete="off"
                                           checked="@(_selectedSource == source.Type)"
                                           @onchange="@(() => _selectedSource = source.Type)" />
                                    <label class="btn btn-outline-primary" for="source-@source.Type">
                                        <i class="fa-solid @source.Icon me-1"></i>
                                        @source.Name
                                    </label>
                                }
                            </div>
                        </div>

                        @* Help Text *@
                        <div class="alert alert-light mb-3">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            @GetHelpText()
                        </div>

                        @* Input Area *@
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                Paste your @GetSourceLabel() below:
                            </label>
                            <textarea class="form-control font-monospace" rows="12"
                                      @bind="_inputText" @bind:event="oninput"
                                      placeholder="@GetPlaceholder()"></textarea>
                        </div>
                    } else {
                        @* Results View *@
                        <div class="mb-3">
                            @if (_importResult?.Success == true) {
                                <div class="alert alert-success d-flex align-items-center">
                                    <i class="fa-solid fa-check-circle me-2 fa-lg"></i>
                                    <div>
                                        <strong>Import Successful</strong>
                                        <div class="small">@_importResult.Message</div>
                                    </div>
                                    <div class="ms-auto">
                                        <span class="badge bg-white text-success fs-6">
                                            Confidence: @_importResult.ConfidenceScore%
                                        </span>
                                    </div>
                                </div>
                            } else {
                                <div class="alert alert-danger d-flex align-items-center">
                                    <i class="fa-solid fa-exclamation-circle me-2 fa-lg"></i>
                                    <div>
                                        <strong>Import Failed</strong>
                                        <div class="small">@_importResult?.Message</div>
                                    </div>
                                </div>
                            }
                        </div>

                        @if (_importResult?.Success == true) {
                            @* Entity Name *@
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Entity Name</label>
                                    <input type="text" class="form-control" @bind="_importResult.Entity.Name" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Plural Name</label>
                                    <input type="text" class="form-control" @bind="_importResult.Entity.PluralName" />
                                </div>
                            </div>

                            @* Imported Properties Preview *@
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fa-solid fa-list me-1"></i>
                                    Imported Properties (@_importResult.Entity.Properties.Count)
                                </label>
                                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 30px;"></th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Required</th>
                                                <th>Max Length</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var prop in _importResult.Entity.Properties) {
                                                <tr class="@(prop.IsPrimaryKey ? "table-warning" : "") @(prop.IsSystemField ? "table-secondary" : "")">
                                                    <td>
                                                        @if (prop.IsPrimaryKey) {
                                                            <i class="fa-solid fa-key text-warning" title="Primary Key"></i>
                                                        } else if (prop.IsSystemField) {
                                                            <i class="fa-solid fa-cog text-muted" title="System Field"></i>
                                                        } else {
                                                            <i class="fa-solid fa-file-import text-info" title="Imported"></i>
                                                        }
                                                    </td>
                                                    <td><strong>@prop.Name</strong></td>
                                                    <td><span class="badge bg-secondary">@prop.Type</span></td>
                                                    <td>
                                                        @if (prop.IsRequired) {
                                                            <i class="fa-solid fa-check text-success"></i>
                                                        }
                                                    </td>
                                                    <td>@prop.MaxLength</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            @* Warnings *@
                            @if (_importResult.Warnings.Any()) {
                                <div class="mb-3">
                                    <label class="form-label fw-semibold text-warning">
                                        <i class="fa-solid fa-triangle-exclamation me-1"></i>
                                        Warnings (@_importResult.Warnings.Count)
                                    </label>
                                    <div class="list-group" style="max-height: 150px; overflow-y: auto;">
                                        @foreach (var warning in _importResult.Warnings) {
                                            <div class="list-group-item list-group-item-@GetWarningClass(warning.Severity) py-2">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <strong>@warning.FieldName:</strong>
                                                        @warning.Message
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(warning.Suggestion)) {
                                                        <small class="text-muted ms-2">@warning.Suggestion</small>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
                <div class="modal-footer">
                    @if (!_showResults) {
                        <button type="button" class="btn btn-secondary" @onclick="Close">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="ParseInput"
                                disabled="@(string.IsNullOrWhiteSpace(_inputText) || _isParsing)">
                            @if (_isParsing) {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                                <span>Parsing...</span>
                            } else {
                                <i class="fa-solid fa-magnifying-glass me-1"></i>
                                <span>Parse & Preview</span>
                            }
                        </button>
                    } else {
                        <button type="button" class="btn btn-secondary" @onclick="@(() => _showResults = false)">
                            <i class="fa-solid fa-arrow-left me-1"></i>
                            Back to Input
                        </button>
                        @if (_importResult?.Success == true) {
                            <button type="button" class="btn btn-success" @onclick="ApplyImport">
                                <i class="fa-solid fa-check me-1"></i>
                                Apply Import
                            </button>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback<DataObjects.ImportResult> OnImportApplied { get; set; }

    private DataObjects.ImportSourceType _selectedSource = DataObjects.ImportSourceType.CSharpClass;
    private string _inputText = "";
    private bool _isParsing = false;
    private bool _showResults = false;
    private DataObjects.ImportResult? _importResult;

    private record SourceTypeInfo(DataObjects.ImportSourceType Type, string Name, string Icon);

    private readonly SourceTypeInfo[] _sourceTypes = {
        new(DataObjects.ImportSourceType.CSharpClass, "C# Class", "fa-code"),
        new(DataObjects.ImportSourceType.JsonSchema, "JSON Schema", "fa-brackets-curly")
    };

    private string GetHelpText() => _selectedSource switch {
        DataObjects.ImportSourceType.CSharpClass =>
            "Paste a C# entity class. Properties with { get; set; } will be detected. Attributes like [Required] and [MaxLength] are parsed.",
        DataObjects.ImportSourceType.JsonSchema =>
            "Paste a JSON Schema or JSON object. Property names and types will be extracted.",
        _ => "Select a source type above."
    };

    private string GetSourceLabel() => _selectedSource switch {
        DataObjects.ImportSourceType.CSharpClass => "C# class",
        DataObjects.ImportSourceType.JsonSchema => "JSON schema",
        _ => "content"
    };

    private string GetPlaceholder() => _selectedSource switch {
        DataObjects.ImportSourceType.CSharpClass =>
@"public class Customer
{
    public Guid CustomerId { get; set; }

    [Required]
    [MaxLength(200)]
    public string Name { get; set; }

    public string? Email { get; set; }
    public bool IsActive { get; set; } = true;
}",
        DataObjects.ImportSourceType.JsonSchema =>
@"{
  ""title"": ""Customer"",
  ""type"": ""object"",
  ""properties"": {
    ""name"": { ""type"": ""string"" },
    ""email"": { ""type"": ""string"" },
    ""age"": { ""type"": ""integer"" }
  }
}",
        _ => ""
    };

    private string GetWarningClass(string severity) => severity switch {
        "Error" => "danger",
        "Warning" => "warning",
        "Info" => "info",
        _ => "light"
    };

    private async Task ParseInput() {
        _isParsing = true;
        StateHasChanged();

        // Small delay for UI feedback
        await Task.Delay(300);

        _importResult = _selectedSource switch {
            DataObjects.ImportSourceType.CSharpClass => EntityWizardImportParser.ParseCSharpClass(_inputText),
            DataObjects.ImportSourceType.JsonSchema => EntityWizardImportParser.ParseJsonSchema(_inputText),
            _ => new DataObjects.ImportResult { Success = false, Message = "Unknown source type" }
        };

        _showResults = true;
        _isParsing = false;
        StateHasChanged();
    }

    private async Task ApplyImport() {
        if (_importResult != null) {
            await OnImportApplied.InvokeAsync(_importResult);
        }
        await Close();
    }

    private async Task Close() {
        _inputText = "";
        _showResults = false;
        _importResult = null;
        await IsOpenChanged.InvokeAsync(false);
    }
}
